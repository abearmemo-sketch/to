<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toggl Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: rgba(0, 0, 0, 0.15);
        }
        #timer-display {
            font-family: 'Roboto Mono', monospace;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

<div class="w-full max-w-md flex flex-col items-center text-center">
    <h1 class="text-xl md:text-2xl font-bold mb-4 text-gray-400">Toggl Timer</h1>

    <div id="status-display" class="w-full flex flex-col items-center">
        <div id="project-description" class="hidden text-xl md:text-2xl font-semibold mb-2 truncate w-full px-2"></div>
        <div id="timer-display" class="hidden text-5xl md:text-6xl font-extrabold tracking-tight mb-2">
            <span id="timer-text">00:00</span>
        </div>
        <div id="start-time" class="hidden text-sm text-gray-400 mb-4"></div>
        <div id="status-message" class="text-lg md:text-xl font-semibold mb-4">讀取中...</div>
    </div>
</div>

<script>
    const PROXY_URL = "/api/TTTT"; 
    const statusMessage = document.getElementById('status-message');
    const projectDescription = document.getElementById('project-description');
    const timerDisplay = document.getElementById('timer-display');
    const startTimeDiv = document.getElementById('start-time');

    let timerInterval = null;
    let startTime = null;

    function formatElapsed(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        const pad = (num) => String(num).padStart(2, '0');

        if (hours > 0) {
            return `${hours}:${pad(minutes)}:${pad(seconds)}`;
        } else {
            return `${pad(minutes)}:${pad(seconds)}`;
        }
    }

    function formatStartTime(date) {
        return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    }

    async function fetchTogglTimer() {
        try {
            const res = await fetch(PROXY_URL);
            const data = await res.json();
            console.log("API 回傳:", data);

            if (timerInterval) clearInterval(timerInterval);

            if (data.current_timer && data.current_timer.id) {
                const entry = data.current_timer;
                const desc = entry.description || "（無描述）";
                startTime = new Date(entry.start);

                statusMessage.classList.add('hidden');
                projectDescription.classList.remove('hidden');
                timerDisplay.classList.remove('hidden');
                startTimeDiv.classList.remove('hidden');

                projectDescription.textContent = desc;
                projectDescription.title = desc;

                startTimeDiv.textContent = `( start at: ${formatStartTime(startTime)} )`;

                function updateElapsed() {
                    if (!startTime) return;
                    const now = new Date();
                    const diffInSeconds = Math.floor((now - startTime) / 1000);
                    document.getElementById('timer-text').textContent = formatElapsed(diffInSeconds);
                }

                updateElapsed();
                timerInterval = setInterval(updateElapsed, 1000);

            } else {
                if (timerInterval) clearInterval(timerInterval);
                startTime = null;
                timerDisplay.classList.add('hidden');
                projectDescription.classList.add('hidden');
                startTimeDiv.classList.add('hidden');
                statusMessage.classList.remove('hidden');
                statusMessage.textContent = "目前沒有計時";
            }
        } catch (err) {
            console.error("讀取計時器失敗:", err);
            if (timerInterval) clearInterval(timerInterval);
            startTime = null;
            timerDisplay.classList.add('hidden');
            projectDescription.classList.add('hidden');
            startTimeDiv.classList.add('hidden');
            statusMessage.classList.remove('hidden');
            statusMessage.textContent = `讀取失敗，請檢查網路或 API 設定`;
        }
    }

    window.onload = function() {
        fetchTogglTimer();
        setInterval(fetchTogglTimer, 60000); // 每分鐘更新一次 API
    };
</script>
</body>
</html>
